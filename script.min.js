$(document).ready(systemInit);
function systemInit(){console.log("JS INIT");$("body").bind("touchmove",function(a){a.preventDefault()});!0===system.overlay_active&&($("#overlay").css("display","unset"),$("#overlay").click(function(){console.warn("User acknowledged warning. View './README.md' for more information.");$("#overlay").css("opacity","0");setTimeout(function(){system.overlay_active=!1;$("#overlay").remove()},500)}));orientationInit();initButtons();if(system.simulate){var a=0;system.enable_ahrs_ws=!1;$("#simulate_tag").css("display",
"unset");setInterval(function(){system.simulate&&(a++,headingTape.update(+a),ahrsTape.update(7*Math.sin(a/10),12*Math.cos(a/15+.7)),speedTape.update(9*Math.sin(a/20+.5)+70),altTape.update(75*Math.cos(a/18+.3)+1423),vspeedTape.update(2*Math.sin(a/18+.3)+4),slipSkid.update(Math.sin(a/27)),satCount.update(7),$("#message_flag").toggleClass("bright"))},250)}setInterval(checkValid,250);setInterval(refreshIfInvalidTimeout,system.checkActiveTime);!1===system.simulate&&initWS()}
var ahrsWS,avgCount=0,headingAvg=[0,0,0,0,0,0,0,0,0,0],system_status={},presist={overheat:!1};function initWS(){!0===system.enable_ahrs_ws&&(ahrsWSInit(),setInterval(ahrsWS.checkActive,250));!0===system.enable_fmu&&(fmuInit(),setInterval(fmuWS.checkActive,1E3))}function avg(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b/a.length}
function ahrsWSInit(){console.log("Attempting to connect to "+system.websocket_url);try{ahrsWS.close()}catch(b){}ahrsWS=new WebSocket(system.websocket_url);ahrsWS.closed=!0;ahrsWS.lastMessage=(new Date).getTime();ahrsWS.onopen=function(a){console.log("Connection established!");console.log(a);ahrsWS.closed=!1};ahrsWS.onclose=function(a){ahrsWS.closed=!0;var b=a.target.url.substr(a.target.url.lastIndexOf("/")+1);a.wasClean?console.log('Websocket "'+b+'" closed cleanly.'):console.warn('Websocket "'+
b+'" did not closed cleanly.');console.log("Reconnecting after 0.5 seconds:");setTimeout(function(){ahrsWSInit()},500)};ahrsWS.checkActive=function(){!1!==system.checkWS&&!0!==ahrsWS.closed&&(new Date).getTime()-system.ahrs.updateTimeout>ahrsWS.lastMessage&&(ahrsWS.close(),console.log("Reconnecting after 0.5 seconds:"),setTimeout(function(){ahrsWS=void 0;ahrsWSInit()},500))};ahrsWS.onmessage=function(a){ahrsWS.lastMessage=(new Date).getTime();$("#message_flag").toggleClass("bright");if(a.isTrusted){a=
JSON.parse(a.data);var b=!1;switch(a.GPSFixQuality){case 2:case 1:7>a.GPSSatellitesSeen||0==a.GPSLatitude||0==a.GPSLongitude||7>a.GPSNACp||100<a.GPSHorizontalAccuracy||500<a.GPSVerticalAccuracy||(b=!0,satCount.update(a.GPSSatellites),speedTape.update(a.GPSGroundSpeed*conv.kts2mps),headingAvg[avgCount]=a.AHRSGyroHeading,headingTape.update(a.AHRSGyroHeading),avgCount++,avgCount>headingAvg.length-1&&(avgCount=0))}switch(altTape.source){case SOURCE.GPS:b&&altTape.update(a.GPSAltitudeMSL*conv.ft2m);break;
case SOURCE.BARO:99999!==a.BaroVerticalSpeed&&99999!==a.BaroPressureAltitude&&altTape.update(a.BaroPressureAltitude*conv.ft2m)}99999!==a.BaroVerticalSpeed&&99999!==a.BaroPressureAltitude&&vspeedTape.update(a.BaroVerticalSpeed*conv.fps2mps);1!==a.AHRSStatus&&(ahrsTape.update(a.AHRSPitch,a.AHRSRoll),slipSkid.update(a.AHRSSlipSkid),gMeter.update(a.AHRSGLoad));!1===presist.overheat&&system_status.CPUTemp>system.cpu_temp_warn?(presist.overheat=!0,$("#overheat_flag").css("display","block")):!0===presist.overheat&&
system_status.CPUTemp<system.cpu_temp_warn&&(presist.overheat=!1,$("#overheat_flag").css("display","none"))}else console.log("Invalid data")};ahrsWS.onerror=function(a){a=a.target.url.substr(a.target.url.lastIndexOf("/")+1);console.error('Websocket "'+a+'" had an error.');ahrsWS.close()};var a=!0;setInterval(function(){!0===a&&(a=!1,$.getJSON(system.status_url,function(a){system_status=a}).always(function(){a=!0}))},1E3)}var fmuWS;
function fmuInit(){console.log("Attempting to connect to "+system.fmu_url);try{fmuWS.close()}catch(a){}fmuWS=new WebSocket(system.fmu_url);fmuWS.lastMessage=(new Date).getTime();fmuWS.closed=!0;fmuWS.onopen=function(a){console.log("Connection established!");console.log(a);fmuWS.closed=!1};fmuWS.onclose=function(a){fmuWS.closed=!0;var b=a.target.url.substr(a.target.url.lastIndexOf("/")+1);a.wasClean?console.log('Websocket "'+b+'" closed cleanly.'):console.warn('Websocket "'+b+'" did not closed cleanly.');
console.log("Reconnecting after 0.5 seconds:");setTimeout(function(){fmuInit()},500)};fmuWS.checkActive=function(){!1!==system.checkWS&&!0!==fmuWS.closed&&(new Date).getTime()-system.fmu.updateTimeout>fmuWS.lastMessage&&fmuWS.close()};fmuWS.onmessage=function(a){fmuWS.lastMessage=(new Date).getTime();$("#message_flag").toggleClass("bright");a.isTrusted&&(a=JSON.parse(a.data),headingTape.updateFMU(a.hdg),speedTape.updateFMU(a.spd),altTape.updateFMU(a.alt))};fmuWS.onerror=function(a){a=a.target.url.substr(a.target.url.lastIndexOf("/")+
1);console.error('Websocket "'+a+'" had an error.');fmuWS.close()}}
function initButtons(){$("#pitch_readout").click(function(){1==confirm("Center AHRS?")&&post("cageAHRS")});$("#roll_readout").click(function(){1==confirm("Calibrate GYRO?")&&post("calibrateAHRS")});$("#simulate_tag").click(function(){!0===system.simulate&&(system.simulate=!1,system.enable_ahrs_ws=!0,initWS(),$("#simulate_tag").css("display","none"))});$("#alt_annun").click(function(){for(var a=0,b=0;b<altTape.possibleSources.length;b++)if(altTape.possibleSources[b]===altTape.source){a=b;break}a++;
a>=altTape.possibleSources.length&&(a=0);altTape.source=altTape.possibleSources[a];switch(altTape.source){case SOURCE.BARO:$("#alt_annun_text").html("Baro Altitude <span>"+altTape.unitPrefix+", "+vspeedTape.unitPrefix+"</span>");break;case SOURCE.GPS:$("#alt_annun_text").html("GPS Altitude <span>"+altTape.unitPrefix+", "+vspeedTape.unitPrefix+"</span>");break;case SOURCE.INPUT:return}vspeedTape.source=altTape.source});system.checkWS=!0;system.smooth=!0;$("#sat_count").click(function(){var a=confirm((system.smooth?
"Disable":"Enable")+" Smoothing?");0==a?(a=confirm((system.checkWS?"Disable":"Enable")+" Check WS?"),1==a&&(system.checkWS=!system.checkWS)):(system.smooth=!system.smooth,system.smooth?($("html").css("--ease_time","0.2s"),$("html").css("--hdg_ease_time","0.2s"),$("html").css("--aux_ease_time","0.2s")):($("html").css("--ease_time","0s"),$("html").css("--hdg_ease_time","0s"),$("html").css("--aux_ease_time","0s")))})}var currentHeading=0,updateHeading=0;
function generateTapes(){$("div.volitile").remove();speedTape.width=$("#speed_tape").outerWidth();speedTape.height=$("#speed_tape").outerHeight();altTape.width=$("#alt_tape").outerWidth();altTape.height=$("#alt_tape").outerHeight();vspeedTape.width=$("#alt_vspeed").outerWidth();vspeedTape.height=$("#alt_vspeed").outerHeight();ahrsTape.width=$("#pitch_indicator").outerWidth();ahrsTape.height=$("#pitch_indicator").outerHeight();headingTape.height=$("#heading_tape").outerHeight();headingTape.width=$("#heading_tape").outerWidth();
gMeter.height=$("#speed_tape").outerHeight();gMeter.width=$("#speed_tape").outerWidth();switch(speedTape.units){case UNITS.KTS:speedTape.unitPrefix="KTS";speedTape.conv=conv.mps2kts;break;case UNITS.MPH:speedTape.unitPrefix="MPH";speedTape.conv=conv.mps2mph;break;case UNITS.MPS:speedTape.unitPrefix="M/S";speedTape.conv=1;break;case UNITS.FPS:speedTape.unitPrefix="Ft/S";speedTape.conv=conv.mps2fps;break;case UNITS.FPM:speedTape.unitPrefix="Ft/M";speedTape.conv=conv.mps2fpm;break;case UNITS.KPH:speedTape.unitPrefix=
"KPH";speedTape.conv=conv.mps2kph;break;case UNITS.MPM:speedTape.unitPrefix="M/Min";speedTape.conv=conv.mps2mpm;break;default:console.error("Cannot use speed unit: "+speedTape.units)}speedTape.lowerSpeed=Math.round(speedTape.conv*speedTape.lowerSpeed*conv.mph2mps);speedTape.upperSpeed=Math.round(speedTape.conv*speedTape.upperSpeed*conv.mph2mps);for(var a=0;a<speedTape.speeds.length;a++)speedTape.speeds[a].start=Math.round(speedTape.speeds[a].start*conv.mph2mps*speedTape.conv),speedTape.speeds[a].end=
Math.round(speedTape.speeds[a].end*conv.mph2mps*speedTape.conv);$("#speed_annun_text").html("GPS GS "+speedTape.unitPrefix);switch(altTape.units){case UNITS.FEET:altTape.unitPrefix="Feet";altTape.conv=conv.m2ft;break;case UNITS.METERS:altTape.unitPrefix="Meters";altTape.conv=1;break;case UNITS.MILES:altTape.unitPrefix="Mils";altTape.conv=conv.m2mi;break;case UNITS.NAUTICLE_MILES:altTape.unitPrefix="N Miles";altTape.conv=conv.m2nmi;break;default:console.error("Cannot use altitude unit: "+altTape.units)}switch(vspeedTape.units){case UNITS.KTS:vspeedTape.unitPrefix=
"KTS";vspeedTape.conv=conv.mps2kts;break;case UNITS.MPH:vspeedTape.unitPrefix="MPH";vspeedTape.conv=conv.mps2mph;break;case UNITS.MPS:vspeedTape.unitPrefix="M/S";vspeedTape.conv=1;break;case UNITS.FPS:vspeedTape.unitPrefix="FPS";vspeedTape.conv=conv.mps2fps;break;case UNITS.FPM:vspeedTape.unitPrefix="FPM";vspeedTape.conv=conv.mps2fpm;break;case UNITS.KPH:vspeedTape.unitPrefix="KPH";vspeedTape.conv=conv.mps2kph;break;case UNITS.MPM:vspeedTape.unitPrefix="M/Min";vspeedTape.conv=conv.mps2mpm;break;default:console.error("Cannot use vspeed unit: "+
vspeedTape.units)}$("#alt_annun_text span").html(altTape.unitPrefix+", "+vspeedTape.unitPrefix);speedTape.pixels_per_number=10;speedTape.fmu_speed=NaN;speedTape.updateFMU=function(a){speedTape.fmu_speed=a};for(a=speedTape.upperSpeed;a>=speedTape.lowerSpeed;a-=10)var b=$("#speed_tape_text").append('<div class="speed_tape_index volitile">'+a+"</div>");speedTape.total_height=100*(speedTape.upperSpeed-speedTape.lowerSpeed)/10;speedTape.offset=parseInt($("#speed_tape_text").css("margin-top").replace("px",
""))+parseInt($("#speed_tape_text").css("line-height").replace("px",""))/2+4;for(a=0;a<speedTape.speeds.length;a++){var b=speedTape.speeds[a],c=$("<div/>",{"class":"speed_tape_color_bar volitile"});b.start===speedTape.lowerSpeed?(c.css("height",(b.end-b.start)*speedTape.pixels_per_number+speedTape.offset),c.css("top",(speedTape.upperSpeed-b.end)*speedTape.pixels_per_number+speedTape.offset)):b.end===speedTape.upperSpeed?(c.css("height",(b.end-b.start)*speedTape.pixels_per_number+speedTape.offset),
c.css("top",(speedTape.upperSpeed-b.end)*speedTape.pixels_per_number)):(c.css("height",(b.end-b.start)*speedTape.pixels_per_number),c.css("top",(speedTape.upperSpeed-b.end)*speedTape.pixels_per_number+speedTape.offset));switch(b.color){case COLORS.GREEN:c.css("background-color","#0F0");break;case COLORS.YELLOW:c.css("background-color","#FF0");break;case COLORS.RED:c.css("background-color","#F00");break;case COLORS.WHITE:c.css("background-color","#FFF"),c.css("width","10px"),c.css("z-index","-1")}$("#speed_tape_tick_holder").append(c)}b=
4;for(a=speedTape.upperSpeed;a>=speedTape.lowerSpeed;a-=5)c=$("<div/>",{"class":"h_tick volitile"}),c.css("top",a*speedTape.pixels_per_number+speedTape.offset-b),0===a%10&&c.css("width","150%"),$("#speed_tape_tick_holder").append(c),speedTape.total_height=Math.max(speedTape.total_height,a*speedTape.pixels_per_number+speedTape.offset-b);$("#speed_tape_scroll").append('<div id="speed_fmu" class="fmu_h volitile"></div>');speedTape.update=function(a,b){a*=speedTape.conv;$("#speed_tape_scroll").css("top",
a*speedTape.pixels_per_number-speedTape.total_height+system.ahrs.height/2-2);a=Math.round(a);10>a?$("#speed_counter_text").html("00"+a):100>a?$("#speed_counter_text").html("0"+a):$("#speed_counter_text").html(a);isNaN(speedTape.fmu_speed)||null==speedTape.fmu_speed?$("#speed_fmu").css("display","none"):($("#speed_fmu").css("display","block"),$("#speed_fmu").css("bottom",-(speedTape.upperSpeed-speedTape.fmu_speed)*speedTape.pixels_per_number-30+"px"));checkIn(AHRS_TYPE.SPEED,b)};b=4;altTape.pixels_per_number=
2.2;altTape.total_height=0;altTape.offset=speedTape.offset;altTape.fmu_alt=NaN;altTape.updateFMU=function(a){altTape.fmu_alt=a};$("#alt_tape_scroll").append('<div id="alt_fmu" class="fmu_h volitile"></div>');for(a=1E3;0<=a;a-=10)c=$("<div/>",{"class":"h_tick alt_tick volitile"}),c.css("top",a*altTape.pixels_per_number+altTape.offset-b),0===a%50&&c.css("width","175%"),$("#alt_tape_tick_holder").append(c),altTape.total_height=Math.max(altTape.total_height,a*altTape.pixels_per_number+altTape.offset-
b);$("#alt_tape_text").append('<div class="alt_tape_index volitile"></div>');for(a=950;0<a;a-=50)$("#alt_tape_text").append('<div class="alt_tape_index volitile">'+a+"0</div>");$("#alt_tape_text").append('<div class="alt_tape_index volitile">0</div>');altTape.update=function(a,b){a*=altTape.conv;$("#alt_tape_scroll").css("top",a/10*altTape.pixels_per_number-altTape.total_height+system.ahrs.height/2-2);a=Math.round(a);10>a?$("#alt_counter_text").html("000"+a):100>a?$("#alt_counter_text").html("00"+
a):1E3>a?$("#alt_counter_text").html("0"+a):$("#alt_counter_text").html(a);isNaN(altTape.fmu_alt)||null==altTape.fmu_alt?$("#alt_fmu").css("display","none"):($("#alt_fmu").css("bottom",-(1E4-altTape.fmu_alt)*altTape.pixels_per_number/10-30+"px"),$("#alt_fmu").css("display","block"));checkIn(AHRS_TYPE.ALT,b)};altTape.possibleSources=[SOURCE.BARO,SOURCE.GPS];altTape.source=SOURCE.BARO;vspeedTape.source=altTape.source;vspeedTape.total_offset=7;vspeedTape.offset=$("#alt_vspeed").outerHeight()/2+vspeedTape.total_offset;
vspeedTape.pixels_per_number=22;b=4;for(a=15;-15<=a;--a)c=$("<div/>",{"class":"h_tick vspeed_tick volitile"}),c.css("top",a*vspeedTape.pixels_per_number+vspeedTape.offset-b),0===a%5&&(c.css("width","20px"),c.css("height","4px")),$("#vspeed_tape_tick_holder").append(c),altTape.total_height=Math.max(altTape.total_height,a*vspeedTape.pixels_per_number+vspeedTape.offset-b);c=$("#alt_vspeed").outerHeight()/2-16*vspeedTape.pixels_per_number+8+vspeedTape.total_offset;for(a=15;0<=a;a-=5)b=$("<div/>",{"class":"vspeed_tape_index volitile",
html:a}),b.css("top",c),$("#vspeed_tape_text").append(b),c+=5*vspeedTape.pixels_per_number;for(a=5;15>=a;a+=5)b=$("<div/>",{"class":"vspeed_tape_index volitile",html:a}),b.css("top",c),$("#vspeed_tape_text").append(b),c+=5*vspeedTape.pixels_per_number;vspeedTape.update=function(a,b){a*=vspeedTape.conv;a/=1E4;$("#vspeed_pointer").css("top",vspeedTape.height/2-a*vspeedTape.pixels_per_number-$("#vspeed_pointer").outerHeight()/2-14+vspeedTape.total_offset);0<a?($("#vspeed_trail").css("top",vspeedTape.height/
2-a*vspeedTape.pixels_per_number-3+vspeedTape.total_offset),$("#vspeed_trail").css("height",a*vspeedTape.pixels_per_number)):($("#vspeed_trail").css("height",-a*vspeedTape.pixels_per_number),$("#vspeed_trail").css("top",vspeedTape.height/2-3+vspeedTape.total_offset));checkIn(AHRS_TYPE.VSPEED,b)};ahrsTape.pixels_per_tick=ahrsTape.height/(ahrsTape.degrees_in_view/2.5);ahrsTape.total_height=0;ahrsTape.ticks=[];for(c=b=0;c<ahrsTape.chevrons;c++){var d=$("<img/>",{"class":"ahrs_chevron volitile",src:"images/chevron.svg"});
d.css("top",-c*ahrsTape.chevron_space-150);ahrsTape.ticks.push({angle:a,val:d,type:"chevron"});$("#pitch_tape_scroll").append(d)}for(a=ahrsTape.limits[0];a>=ahrsTape.limits[1];a-=2.5){c=$("<div/>",{"class":"h_tick ahrs_tick volitile"});c.css("top",b*ahrsTape.pixels_per_tick);if(0!==a){0===a%5&&(c.css("width","80px"),c.css("height","4px"));if(0===a%10){c.css("width","120px");c.css("height","4px");for(var h=0;2>h;h++)d=$("<div/>",{"class":"ahrs_text volitile noselect"}),d.html(0>a?-a:a),d.css("top",
b*ahrsTape.pixels_per_tick-8),0===h?d.css("left","0px"):d.css("right","0px"),ahrsTape.ticks.push({angle:a,val:d,type:"text"}),$("#pitch_tape_scroll").append(d)}ahrsTape.ticks.push({angle:a,val:c,type:"tick"});$("#pitch_tape_scroll").append(c)}ahrsTape.total_height=Math.max(ahrsTape.total_height,b*ahrsTape.pixels_per_tick);$("#pitch_tape_scroll").css("top",-ahrsTape.total_height/2+ahrsTape.height/2-2);b++}for(c=0;c<ahrsTape.chevrons;c++)d=$("<img/>",{"class":"ahrs_chevron volitile",src:"images/chevron_flip.svg"}),
d.css("top",ahrsTape.total_height+c*ahrsTape.chevron_space+50),ahrsTape.ticks.push({angle:a,val:d,type:"chevron"}),$("#pitch_tape_scroll").append(d);ahrsTape.update=function(a,b,c){$("html").css("--pitch_amount",4*a*ahrsTape.pixels_per_tick/10-3);for(var d=0;d<ahrsTape.ticks.length;d++){var e=ahrsTape.ticks[d],f=Math.abs(a-e.angle);f<=ahrsTape.degrees_in_view/3?"text"===e.type?e.val.css("color","white"):"tick"===e.type&&e.val.css("background-color","white"):f<=ahrsTape.degrees_in_view/2?(f="rgba(255,255,255,"+
Math.abs((f-ahrsTape.degrees_in_view/2)/(ahrsTape.degrees_in_view/2-ahrsTape.degrees_in_view/3))+")","text"===e.type?e.val.css("color",f):"tick"===e.type&&e.val.css("background-color",f)):"text"===e.type?e.val.css("color","transparent"):"tick"===e.type&&e.val.css("background-color","transparent")}$("html").css("--flight_angle",-b+"deg");.5>Math.abs(a)?$("#pitch_readout span").html(pad(Math.round(Math.abs(a)),2)+"\u00b0-"):$("#pitch_readout span").html(pad(Math.round(Math.abs(a)),2)+"\u00b0"+(0>a?
"D":"U"));.5>Math.abs(b)?$("#roll_readout span").html(pad(Math.round(Math.abs(b)),2)+"\u00b0-"):$("#roll_readout span").html(pad(Math.round(Math.abs(b)),2)+"\u00b0"+(0>b?"L":"R"));checkIn(AHRS_TYPE.AHRS,c)};slipSkid.update=function(a,b){$("html").css("--slip_skid",50*a+"px")};headingTape.safetyOffset=30;"0s"===$("html").css("--hdg_ease_time").trim()?headingTape.removeAnimation=!0:headingTape.removeAnimation=!1;headingTape.fmu_hdg=NaN;headingTape.forceRedraw=!1;headingTape.updateFMU=function(a){null==
a||isNaN(a)?headingTape.fmu_hdg=null:headingTape.fmu_hdg=constrainDegree(a);headingTape.forceRedraw=!0};headingTape.span=headingTape.width/headingTape.ticks_per_number/2;headingTape.update=function(a,b){a=constrainDegree(Math.round(a));headingTape.heading=a;$("#heading_text span").html(pad(a,3)+"\u00b0");if(!0===headingTape.forceRedraw||getDegreeDistance(updateHeading,a)>=headingTape.safetyOffset/2)headingTape.redrawHeadingTape(currentHeading,a),updateHeading=a;constrainDegree(updateHeading-a);var c=
-(getDegreeDistance(headingTape.left_heading,a)*headingTape.pixels_per_tick-headingTape.pixels_per_tick*headingTape.padding);setTimeout(function(){headingTape.removeAnimation||$("#heading_tape_scroll").css("transition","all var(--hdg_ease_time) ease 0s");$("#heading_tape_scroll").css("left",c)},10);currentHeading=a;!isNaN(headingTape.fmu_hdg)&&null!=headingTape.fmu_hdg&&getDegreeDistance(headingTape.heading,headingTape.fmu_hdg,!1)>headingTape.span/2+1?($("#hdg_fmu_arrow").css("display","block"),!1===
180>constrainDegree(headingTape.heading-headingTape.fmu_hdg)?($("#hdg_fmu_arrow").css("left","unset"),$("#hdg_fmu_arrow").css("right","5px"),$("#hdg_fmu_arrow").css("transform","rotate(180deg)")):($("#hdg_fmu_arrow").css("left","5px"),$("#hdg_fmu_arrow").css("right","unset"),$("#hdg_fmu_arrow").css("transform","rotate(0deg)"))):$("#hdg_fmu_arrow").css("display","none");checkIn(AHRS_TYPE.HDG,b)};headingTape.redrawHeadingTape=function(a,b){headingTape.forceRedraw=!1;headingTape.removeAnimation||$("#heading_tape_scroll").css("transition",
"all 0s ease 0s");$("#heading_tape_scroll").html("");headingTape.pixels_per_tick=(system.ahrs.width-2*$("#speed_tape").outerWidth())/headingTape.range;var c=!(180>constrainDegree(updateHeading-b));headingTape.padding=headingTape.safetyOffset/2;c?(headingTape.left_heading=constrainDegree(a-headingTape.range/2-headingTape.padding),headingTape.right_heading=constrainDegree(b+headingTape.range/2+headingTape.padding)):(headingTape.right_heading=constrainDegree(a+headingTape.range/2+headingTape.padding),
headingTape.left_heading=constrainDegree(b-headingTape.range/2-headingTape.padding));for(var d=headingTape.left_heading,e=0,c=0;d!=headingTape.right_heading;){var f=$("<div/>",{"class":"v_tick volitile"});f.css("left",e*headingTape.pixels_per_tick);if(0===d%headingTape.ticks_per_number){f.css("height","30px");var g=$("<div/>",{"class":"heading_text volitile"});g.html(d);var h=5;100<=d?h*=3:10<=d&&(h*=2);g.css("left",e*headingTape.pixels_per_tick-h);$("#heading_tape_scroll").append(g)}else 0===d%(headingTape.ticks_per_number/
2)&&f.css("height","20px");0===d%90&&(g=$("<div/>",{"class":"heading_text card_text volitile"}),360===d?g.html("N"):90===d?g.html("E"):180===d?g.html("S"):270===d&&g.html("W"),g.css("left",e*headingTape.pixels_per_tick-13),$("#heading_tape_scroll").append(g));$("#heading_tape_scroll").append(f);d=constrainDegree(d+1);e++;c+=headingTape.pixels_per_tick}isNaN(headingTape.fmu_hdg)||null==headingTape.fmu_hdg?$("#hdg_fmu_arrow").css("display","none"):(d=getDegreeDistance(headingTape.left_heading,headingTape.right_heading),
getDegreeDistance(headingTape.left_heading,headingTape.fmu_hdg)<d&&!1===180>constrainDegree(headingTape.left_heading-headingTape.fmu_hdg)&&$("#heading_tape_scroll").append('<div id="hdg_fmu" class="fmu_v"   style="left:'+getDegreeDistance(headingTape.left_heading,headingTape.fmu_hdg)*headingTape.pixels_per_tick+'px;"></div>'));$("#heading_tape_scroll").css("width",c);headingTape.padding_offset=headingTape.padding*headingTape.pixels_per_tick;c=-(getDegreeDistance(headingTape.left_heading,a)*headingTape.pixels_per_tick-
headingTape.pixels_per_tick*headingTape.padding);$("#heading_tape_scroll").css("left",c);$("#heading_tape_scroll").css("bottom","0px")};headingTape.redrawHeadingTape(0,0);if(gMeter.display){b=[[19,4,"1"],[7,30,"2"],[31,30,"0"]];for(a=0;a<b.length;a++)d=$("<div/>",{"class":"g_text volitile noselect"}),d.css("top",b[a][0]),d.css("left",b[a][1]),d.html(b[a][2]),$("#g_meter").append(d);gMeter.update=function(a,b){var c=132*(a-1);$("#g_pointer").css("transform","rotate("+c+"deg)");checkIn(AHRS_TYPE.GMETER,
b)}}else $("#g_meter").css("display","none"),gMeter.update=function(a){};satCount.display?satCount.update=function(a){$("#sat_count_text").html(a)}:($("#sat_count").css("display","none"),satCount.update=function(a){});ahrsTape.update(0,0,!0);headingTape.update(0,!0);speedTape.update(0,!0);altTape.update(0,!0);vspeedTape.update(0,!0);setInvalid(AHRS_TYPE.ALL,!0)}var lastCheckInTime=[];
function checkIn(a,b){if(!0!==b){for(;void 0===lastCheckInTime[a];)lastCheckInTime.push([]);lastCheckInTime[a]=Date.now()}}var invalidList=[!1,!1,!1,!1,!1,!1];
function checkValid(){for(var a=Date.now(),b=0;b<lastCheckInTime.length;b++)if(a-lastCheckInTime[b]>system.ahrs.updateTimeout&&!1===invalidList[b]){switch(b){case AHRS_TYPE.SPEED:speedTape.update(0,!0);satCount.update("-");break;case AHRS_TYPE.ALT:altTape.update(0,!0);break;case AHRS_TYPE.VSPEED:vspeedTape.update(0,!0);break;case AHRS_TYPE.HDG:headingTape.update(0,!0);break;case AHRS_TYPE.AHRS:case AHRS_TYPE.GMETER:ahrsTape.update(0,0,!0),gMeter.update(1,!0),slipSkid.update(0,!0)}setInvalid(b,!0)}else a-
lastCheckInTime[b]<system.ahrs.updateTimeout&&!0===invalidList[b]&&setInvalid(b,!1)}
function setInvalid(a,b){var c;switch(a){case AHRS_TYPE.SPEED:c=["speed_tape"];break;case AHRS_TYPE.ALT:case AHRS_TYPE.VSPEED:c=["alt_tape"];break;case AHRS_TYPE.HDG:c=["heading_tape"];break;case AHRS_TYPE.AHRS:c=["ahrs_container","pitch_readout","roll_readout","slip_skid_holder"];break;case AHRS_TYPE.ALL:c="ahrs_container pitch_readout roll_readout heading_tape alt_tape speed_tape slip_skid_holder".split(" ")}if(void 0!==c){for(var d=0;d<c.length;d++)b?$("#"+c[d]+" .invalid_holder:first").addClass("invalid"):
$("#"+c[d]+" .invalid_holder:first").removeClass("invalid");if(a!==AHRS_TYPE.ALL)invalidList[a]=b;else for(d=0;d<invalidList.length;d++)invalidList[d]=b}}function refreshIfInvalidTimeout(){for(var a=0;a<invalidList.length;a++)if(!1===invalidList[a])return;try{ahrsWS.close(),fmuWS.close()}catch(b){}}function constrainDegree(a){if(0>=a)for(;0>=a;)a+=360;else for(;360<a;)a-=360;return a}function pad(a,b){for(var c=a+"";c.length<b;)c="0"+c;return c}
function getDegreeDistance(a,b,c){c=void 0===c?!0:c;a=Math.abs(Math.min(constrainDegree(a-b),constrainDegree(b-a)));return!1===c&&360==a?0:a}function requestFullScreen(a){var b=a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen||a.msRequestFullScreen;b?b.call(a):"undefined"!==typeof window.ActiveXObject&&(a=new ActiveXObject("WScript.Shell"),null!==a&&a.SendKeys("{F11}"))}
var post=function(a){var b=new XMLHttpRequest;b.open("POST","http://192.168.10.1/"+a,!0);b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.onreadystatechange=function(){4==b.readyState&&200==b.status&&console.log("Done: "+b.responseText)};b.send("")};Math.toDegrees=function(a){return 57.2958*a};
